#### `PREVIOUS TOPIC` [Starters](4_starters.md)
-----

# Exception Handling in Spring Boot [↑](../../../README.md#iv-spring-boot)
Exception handling in Spring Boot helps deal with errors and exceptions present in APIs, delivering a robust enterprise application.

## Key Approaches to Exception Handling in Spring Boot
- Default exception handling by Spring Boot
- Using `@ExceptionHandler` annotation
- Using `@ControllerAdvice` for global exception handling

## Sample Implementation [↑](../../../README.md#iv-spring-boot)

#### Creating a JPA Entity Class
```java
// Creating a JPA Entity class Customer with 
// three fields: id, name, and address
package com.customer.model;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Customer {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String address;
    private String email;
}
```
- `@Entity` annotation (from Jakarta Persistence) is used to declare that a Java class represents an entity which can be mapped to a table in a relational database.
- `@Id` annotation is needed for every entity class which serves as the primary key that is needed in RDB.
- `@Data` annotation from project Lombok for generating standard getters, setters, `toString()`, `equals()`, `hashCode()`, and constructors.
- `@AllArgsConstructor` annotation creates a constructor with all the member fields as a parameter.
- `@GeneratedValue` annotation from JPA specify that the value of a primary key field will be automatically generated by the persistence provider (i.e. Hibernate)

#### Creating the Customer Repository Interface
This interface is for CRUD operations on the Customer Entity. This interface extends the **JpaRepository** which provide built-in methods  for data access.

```java
import java.util.Optional;

@Repository
public interface CustomerRepository extends JpaRepository<Customer, Long> {
  Optional<Customer> findByEmail(String email);
}
```

#### Creating Custom Exceptions

**CustomerAlreadyExistsException** can be thrown when the user tries to add a customer that already exists.
```java
// Creating a custom exception that can be thrown when a user tries to add a customer that already exists
package com.customer.exception;

public class CustomerAlreadyExistsException extends RuntimeException {
    private String message;

    public CustomerAlreadyExistsException() {}

    public CustomerAlreadyExistsException(String msg) {
        super(msg);
        this.message = msg;
    }
}
```

**NoSuchCustomerExistsException** is thrown when the user tries to delete or update a customer record that does not exist in the database.
```java
// Creating a custom exception that can be thrown when a user tries to update/delete a customer that doesn't exist
package com.customer.exception;

public class NoSuchCustomerExistsException extends RuntimeException {
    private String message;

    public NoSuchCustomerExistsException() {}

    public NoSuchCustomerExistsException(String msg) {
        super(msg);
        this.message = msg;
    }
}
```

#### Creating the Service Layer

```java
// Creating service interface
package com.customer.service;
import com.customer.model.Customer;

public interface CustomerService {

    // Method to get customer by its Id
    Customer getCustomer(Long id);

    // Method to add a new Customer
    // into the database
    String addCustomer(Customer customer);

    // Method to update details of a Customer
    String updateCustomer(Customer customer);
}
```

```java
// Implementing the service class
package com.customer.service;

import com.customer.exception.CustomerAlreadyExistsException;
import com.customer.exception.NoSuchCustomerExistsException;
import com.customer.model.Customer;
import com.customer.repository.CustomerRepository;
import java.util.Optional;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class CustomerServiceImpl implements CustomerService {

    @Autowired
    private CustomerRepository customerRespository;

    // Method to get customer by Id. Throws
    // NoSuchElementException for invalid Id
    public Customer getCustomer(Long id) {
        return customerRespository.findById(id).orElseThrow(
            () -> new NoSuchElementException("NO CUSTOMER PRESENT WITH ID = " + id));
    }

  
    // Simplifying the addCustomer and updateCustomer
    // methods with Optional for better readability.
    
    public String addCustomer(Customer customer) {
        Optional<Customer> existingCustomer = customerRespository.findById(customer.getId());
        if (!existingCustomer.isPresent()) {
            customerRespository.save(customer);
            return "Customer added successfully";
        } else {
            throw new CustomerAlreadyExistsException("Customer already exists!!");
        }
    }

    public String updateCustomer(Customer customer) {
        Optional<Customer> existingCustomer = customerRespository.findById(customer.getId());
        if (!existingCustomer.isPresent()) {
            throw new NoSuchCustomerExistsException("No Such Customer exists!!");
        } else {
            existingCustomer.get().setName(customer.getName());
            existingCustomer.get().setAddress(customer.getAddress());
            customerRespository.save(existingCustomer.get());
            return "Record updated Successfully";
        }
    }
}
```

#### Creating the CustomerController

```java
// Creating Rest Controller CustomerController which
// defines various API's.
package com.customer.controller;

import com.customer.exception.CustomerAlreadyExistsException;
import com.customer.exception.ErrorResponse;
import com.customer.exception.NoSuchCustomerExistsException;
import com.customer.model.Customer;
import com.customer.service.CustomerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class CustomerController {

    @Autowired private CustomerService customerService;

    // Get Customer by Id
    @GetMapping("/getCustomer/{id}")
    public Customer getCustomer(@PathVariable("id") Long id) {
        return customerService.getCustomer(id);
    }

    // Add new Customer
    @PostMapping("/addCustomer")
    public String addCustomer(@RequestBody Customer customer) {
        return customerService.addCustomer(customer);
    }

    // Update Customer details
    @PutMapping("/updateCustomer")
    public String updateCustomer(@RequestBody Customer customer) {
        return customerService.updateCustomer(customer);
    }

    // Adding exception handlers for NoSuchCustomerExistsException 
    // and NoSuchElementException.
    @ExceptionHandler(value = NoSuchCustomerExistsException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public ErrorResponse handleNoSuchCustomerExistsException(NoSuchCustomerExistsException ex) {
        return new ErrorResponse(HttpStatus.NOT_FOUND.value(), ex.getMessage());
    }

    @ExceptionHandler(value = NoSuchElementException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public ErrorResponse handleNoSuchElementException(NoSuchElementException ex) {
        return new ErrorResponse(HttpStatus.NOT_FOUND.value(), ex.getMessage());
    }
}
```

## Exception Handling in Spring Boot

### Default Exception Handling by Spring Boot
Spring Boot provides a systematic error response to the user with information such as timestamp, HTTP, status code, error, message, and the path.

```json
{
  "timestamp": "2022-03-01T18:24:31.643+00:00",
  "status": "500",
  "error": "Internal Server Error",
  "message": "NO CUSTOMER PRESENT WITH ID = 2",
  "path": "/getCustomer/2"
}
```

### Using @ExceptionHandler Annotation
- `@ExceptionHandler` can be used to handle exceptions in particular **Handler classes** or **Handler methods**.
- Any method annotated by this is automatically recognized by Spring Configuration as an Exception Handler Method.
- An Exception Handler method handles all exceptions and their subclasses passed in the argument.
- It can also be configured to return a specific error response to the user.

### Using @ControllerAdvice for Global Exception Handling
- Used to handle any exception thrown throughout the application.
- A global exception handler is defined and is annotated with `@ControllerAdvice`.
- Helps integrate multiple exception handlers into a single global unit.

```java
// Class to handle exceptions globally
package com.customer.exception;

import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;

@ControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(value = NoSuchCustomerExistsException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public @ResponseBody ErrorResponse handleException(NoSuchCustomerExistsException ex) {
        return new ErrorResponse(HttpStatus.NOT_FOUND.value(), ex.getMessage());
    }
}
```